#!/bin/bash
#
#SBATCH --partition=all
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=16
#SBATCH --mem=20G
#SBATCH --time=04:00:00
#SBATCH -D /home/jmulder6/projects/elastix
#SBATCH -o /home/jmulder6/projects/elastix/shark/make_release-%j.out

module purge > /dev/null 2>&1
module load system/gcc/11.2.0
module load tools/cmake/3.19.2
module load library/boost/1.72.0/gcc-8.3.1
module load library/blas/0.3.13/gcc-8.3.1
module load library/lapack/3.9.0/gcc-8.3.1

CORES=16
ELASTIX_DIR=$PWD
CMAKE_BUILD_TYPE=Release
WORKING_DIR=$PWD/temp
INSTALL_DIR=$WORKING_DIR/install
mkdir -p $INSTALL_DIR
export ITK_HOME=$WORKING_DIR/ITK

if [[ ! -z "${BUILD_EIGEN}" ]]
then
    cd $WORKING_DIR
    # Configure and install Eigen3
    wget https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.bz2
    tar --bzip2 -xf eigen-3.4.0.tar.bz2 && cd eigen-3.4.0
    cmake --no-warn-unused-cli -DCMAKE_BUILD_TYPE:STRING=$CMAKE_BUILD_TYPE -DCMAKE_INSTALL_PREFIX:STRING=$INSTALL_DIR -H$PWD -B$PWD/build/$CMAKE_BUILD_TYPE
    cmake --build $PWD/build/$CMAKE_BUILD_TYPE --parallel $CORES --config $CMAKE_BUILD_TYPE --target install
    cd $WORKING_DIR
    rm eigen-3.4.0.tar.bz2 && rm -rf eigen-3.4.0
fi

if [[ ! -z "${BUILD_ITK}" ]]
then
    # Configure and install ITK
    cd $WORKING_DIR
    git clone https://github.com/joasiee/ITK.git && cd ITK && git checkout gomea
    cmake --no-warn-unused-cli -DCMAKE_BUILD_TYPE:STRING=$CMAKE_BUILD_TYPE -DCMAKE_PREFIX_PATH:STRING=$INSTALL_DIR -CCMakeDefaultCache.txt -H$PWD -B$PWD/build/$CMAKE_BUILD_TYPE
    cmake --build $PWD/build/$CMAKE_BUILD_TYPE --parallel $CORES --config $CMAKE_BUILD_TYPE --target all
fi

# Configure and install elastix
cd $ELASTIX_DIR
cmake --no-warn-unused-cli -DCMAKE_BUILD_TYPE:STRING=$CMAKE_BUILD_TYPE -DCMAKE_PREFIX_PATH:STRING=$INSTALL_DIR -CCMakeDefaultCache.txt -H$PWD -B$PWD/build/$CMAKE_BUILD_TYPE
cmake --build $PWD/build/$CMAKE_BUILD_TYPE --parallel $CORES --config $CMAKE_BUILD_TYPE --target elastix_exe

